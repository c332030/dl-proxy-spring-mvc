def ext = rootProject.ext
def versions = ext.versions

buildscript {

  apply from: 'config.gradle'

  repositories {
    mavenCentral()
  }

  dependencies {
    classpath("org.springframework.boot:spring-boot-gradle-plugin:${versions.spring_boot}")
  }
}

allprojects {

  apply plugin: 'java-library'
  apply plugin: 'idea'
  apply plugin: 'maven-publish'
  apply plugin: 'org.springframework.boot'
  apply plugin: 'io.spring.dependency-management'

  sourceCompatibility = JavaVersion.VERSION_11
  targetCompatibility = JavaVersion.VERSION_11

  [compileJava, compileTestJava, javadoc]*.options*.encoding = ext.charset

  jar {
    enabled = true

    into("META-INF/resources") {
      from("src/main/webapp")
    }

    into("META-INF/maven/$project.group/$project.name") {
      from { generatePomFileForMavenPublication }
      rename ".*", "pom.xml"
    }

  }

  java {
    withJavadocJar()
    withSourcesJar()
  }

  idea {
    module {
      downloadJavadoc = false
      downloadSources = false
    }
  }

  repositories {
    maven {
      url 'https://oss.sonatype.org/content/groups/public/'
    }
    mavenCentral()
  }

  dependencies {

    implementation 'org.springframework.boot:spring-boot-starter'

    implementation group: 'org.springframework.boot', name: 'spring-boot-starter-web'
    implementation group: 'org.springframework.boot', name: 'spring-boot-starter-jetty'

    implementation group: 'org.springframework.boot', name: 'spring-boot-configuration-processor'
    annotationProcessor group: 'org.springframework.boot', name: 'spring-boot-configuration-processor'

    developmentOnly 'org.springframework.boot:spring-boot-devtools'

    testImplementation(group: 'org.springframework.boot', name: 'spring-boot-starter-test') {
      exclude group: 'org.junit.vintage', module: 'junit-vintage-engine'
    }

    // lombok
    // compileOnly group: "org.projectlombok", name: "lombok", version: versions.lombok
    compileOnly group: "org.projectlombok", name: "lombok"
    annotationProcessor group: "org.projectlombok", name: "lombok"

    testCompileOnly group: "org.projectlombok", name: "lombok"
    testAnnotationProcessor group: "org.projectlombok", name: "lombok"

    testImplementation group: "junit", name: "junit"

    implementation group: "com.c332030.commons", name: "c-commons-util", version: versions.c_commons_java

    implementation group: 'com.c332030.spring', name: 'c-spring-app-web', version: versions.c_commons_spring

  }

  // 实时更新 snapshots
  configurations.all {
    resolutionStrategy.cacheDynamicVersionsFor 1, 'seconds'
    resolutionStrategy.cacheChangingModulesFor 1, 'seconds'
  }

  sourceSets {
    main {
      resources {
        srcDir 'src/main/java'
      }
    }
  }

  test {
    exclude '**/*Test*.class'
  }
}
